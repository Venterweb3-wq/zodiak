# üß† –≠—Ç–∞–ø 5 ‚Äî –ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞ –ª–æ–≥–∏–∫–∏ `market_data_collector`

## üìå –¶–µ–ª—å

–°–æ–∑–¥–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∏ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Å–±–æ—Ä—â–∏–∫ —Ä—ã–Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–π:

- –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∏–ª—å—Ç—Ä—ã –∏–∑ Django (PostgreSQL)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç CoinMarketCap –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å–ø–∏—Å–∫–∞ –º–æ–Ω–µ—Ç
- –î–µ–ª–∞–µ—Ç 6 –∫–ª—é—á–µ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ CoinGlass –ø–æ –∫–∞–∂–¥–æ–π –º–æ–Ω–µ—Ç–µ
- –û–±–Ω–æ–≤–ª—è–µ—Ç –∫–æ–ª–ª–µ–∫—Ü–∏—é MongoDB `coin_market_data`
- –£—á–∏—Ç—ã–≤–∞–µ—Ç –ª–∏–º–∏—Ç 30 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É (1800/—á)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Å—Ç–∞—Ç–æ–∫ –ª–∏–º–∏—Ç–∞ –Ω–∞ `pairs-markets` –∏ –¥—Ä—É–≥–∏–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
- –ì–æ—Ç–æ–≤ –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π Smart Money —Å–µ—Ä–≤–∏—Å

---

## üóÇ –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö

### CoinMarketCap

**–≠–Ω–¥–ø–æ–∏–Ω—Ç:** `getLatestListings` (–¥–æ 5000 –º–æ–Ω–µ—Ç)

–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —É—Å–ª–æ–≤–∏—è–º:
- `volume_24h ‚â• 30M`
- `market_cap ‚â• 300M`
- `num_market_pairs ‚â• 20`
- `percent_change_7d ‚â§ ¬±30%`
- `date_added ‚â• 90 –¥–Ω–µ–π –Ω–∞–∑–∞–¥`
- `tags` –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç: `"memes", "gambling", "ai"`
- `slug` –Ω–µ –≤—Ö–æ–¥–∏—Ç –≤ blacklist
- `cmc_rank ‚â§ 150`
- `num_exchanges ‚â• 5`
- `is_active == true`

–§–∏–ª—å—Ç—Ä—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Å API Django: `/api/smc/cmc-filters/active/`–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å 

---

### CoinGlass (–Ω–∞ –∫–∞–∂–¥—É—é –º–æ–Ω–µ—Ç—É)

| –≠–Ω–¥–ø–æ–∏–Ω—Ç                                                       | –û–ø–∏—Å–∞–Ω–∏–µ                                            | –í—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞            |
|----------------------------------------------------------------|-----------------------------------------------------|---------------------------|
| `/api/futures/pairs-markets`                                   | –û–±—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –ø–æ –ø–∞—Ä–∞–º                              | –û–¥–∏–Ω —Ä–∞–∑, –ª–∏–±–æ –∏–∑ –æ—Å—Ç–∞—Ç–∫–∞ |
| `/api/futures/funding-rate/vol-weight-history`                | –ò—Å—Ç–æ—Ä–∏—è –≤–∑–≤–µ—à–µ–Ω–Ω–æ–π —Å—Ç–∞–≤–∫–∏ —Ñ–∞–Ω–¥–∏–Ω–≥–∞ (30 –¥–Ω–µ–π)        | –ü–æ `last_updated`         |
| `/api/futures/open-interest/aggregated-history`               | –ò—Å—Ç–æ—Ä–∏—è –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞ (OHLC, 30 –¥–Ω–µ–π)          | –ü–æ `last_updated`         |
| `/api/futures/liquidation/history`                            | –õ–∏–∫–≤–∏–¥–∞—Ü–∏–∏ –∑–∞ 24 —á–∞—Å–∞                               | –ö–∞–∂–¥—ã–π —Ü–∏–∫–ª               |
| `/api/futures/taker-buy-sell-volume/exchange-list`           | –û–±—ä—ë–º—ã —Ç–µ–π–∫–µ—Ä–æ–≤ –∑–∞ 4 —á–∞—Å–∞                           | –ö–∞–∂–¥—ã–π —Ü–∏–∫–ª               |
| `/api/price/ohlc-history`                                     | –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Ü–µ–Ω—ã (OHLC)                            | –ü–æ `last_updated`         |

---

## ‚úÖ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- [x] –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏–∑ Django API
- [x] –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–æ 5000 –º–æ–Ω–µ—Ç –ø–æ CMC
- [x] –ó–∞–ø—Ä–æ—Å—ã –∫ CoinGlass –ø–æ –∫–∞–∂–¥–æ–º—É symbol
- [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ø—Ä–æ–ø—É—Å–∫ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –º–æ–Ω–µ—Ç
- [x] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ `coin_market_data`
- [x] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ MongoDB
- [x] –£–≤–∞–∂–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ API
- [x] –û—á–µ—Ä–µ–¥—å –∑–∞–ø—Ä–æ—Å–æ–≤
- [x] –ê–≤—Ç–æ–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
- [x] `.env` –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

---

## üîÅ –û—á–µ—Ä–µ–¥—å –∏ –ª–∏–º–∏—Ç—ã

- –ú–∞–∫—Å–∏–º—É–º: 30 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É = 1800/—á
- 250 –º–æ–Ω–µ—Ç √ó 6 —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ = 1500 –∑–∞–ø—Ä–æ—Å–æ–≤
- –û—Å—Ç–∞—Ç–æ–∫: 300 –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ `pairs-markets` –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫—É

```js
const BATCH_SIZE = 5; // 5 –º–æ–Ω–µ—Ç √ó 6 –∑–∞–ø—Ä–æ—Å–æ–≤ = 30 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω

for (let i = 0; i < coins.length; i += BATCH_SIZE) {
  const batch = coins.slice(i, i + BATCH_SIZE);

  for (const coin of batch) {
    try {
      await fetchAllEndpoints(coin);
      await sleep(500);
    } catch (err) {
      console.error(`[–û—à–∏–±–∫–∞] ${coin.symbol}: ${err.message}`);
    }
  }

  console.log(`‚úÖ Batch ${i / BATCH_SIZE + 1} –∑–∞–≤–µ—Ä—à—ë–Ω`);
  await sleep(60_000); // –æ–∂–∏–¥–∞–Ω–∏–µ 60 —Å–µ–∫
}
```

---

## üîç –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤—ã–∑–æ–≤–æ–≤

### 1. `/api/futures/pairs-markets`
- symbol: `BTC`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 1 —Ä–∞–∑ (–ª–∏–±–æ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –∏–∑ –æ—Å—Ç–∞—Ç–∫–∞)

### 2. `/api/futures/funding-rate/vol-weight-history`
- interval: `'1d'`
- `start_time`: now - 30d (–ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫)
- –∑–∞—Ç–µ–º: `last_updated + 1d`

### 3. `/api/futures/open-interest/aggregated-history`
- symbol: `BTCUSDT`
- unit: `'usd'`
- interval: `'1d'`
- –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ funding rate

### 4. `/api/futures/liquidation/history`
- –≤—Å–µ–≥–¥–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞

### 5. `/api/futures/taker-buy-sell-volume/exchange-list`
- –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —á–∞—Å–∞

### 6. `/api/price/ohlc-history`
- –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ funding rate

---

## üóÑ MongoDB: `coin_market_data`

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞:

```json
{
  "symbol": "BTC",
  "symbol_pair": "BTCUSDT",
  "data": {
    "pairs_markets": {...},
    "funding_rate_vol_weight": [...],
    "open_interest_aggregated": [...],
    "liquidation": {...},
    "taker_volume": {...},
    "price_ohlc": [...]
  },
  "timestamps": {
    "funding_rate_vol_weight": "2025-06-23T12:00:00Z",
    "open_interest_aggregated": "2025-06-23T12:00:00Z",
    "price_ohlc": "2025-06-23T12:00:00Z"
  }
}
```

---

## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (last_updated)

| –ú–µ—Ç—Ä–∏–∫–∞                    | –°–ø–æ—Å–æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è                        |
|---------------------------|------------------------------------------|
| `funding_rate_vol_weight` | –ü–æ `timestamps.funding_rate_vol_weight` |
| `open_interest_aggregated`| –ü–æ `timestamps.open_interest_aggregated`|
| `price_ohlc`              | –ü–æ `timestamps.price_ohlc`              |
| `liquidation`             | –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞                       |
| `taker_volume`            | –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞                       |
| `pairs_markets`           | –ü–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é –∏–ª–∏ –≤—Ä—É—á–Ω—É—é                |

---

## üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ

–¢—ã –º–æ–∂–µ—à—å –¥–æ–±–∞–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –¥—Ä—É–≥–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤, –ø—Ä–æ—Å—Ç–æ —Ä–∞—Å—à–∏—Ä—è—è –ø–æ–ª–µ `data`. –ù–∞–ø—Ä–∏–º–µ—Ä:

```json
"data": {
  ...
  "defillama_tvl": {...},
  "glassnode_metrics": {...}
}
```

–ò –¥–æ–±–∞–≤–ª—è—Ç—å –º–µ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –≤ `"timestamps"`.
