# Аудит кода и структуры сервисов Smart Money и Market Data Collector

## 1. Обзор структуры директорий

### 1.1. `smart_money_service`
- **Описание**: Содержит сервис для нормализации рыночных данных.
- **Файлы**:
  - `market_data_normalizer.js`: Скрипт для обработки сырых данных из MongoDB и записи агрегированных данных.
  - `.env`, `package.json`, `package-lock.json`: Конфигурация и зависимости.

### 1.2. `smart_money_engine`
- **Описание**: Основной движок для анализа рыночных данных и генерации сигналов.
- **Файлы и поддиректории**:
  - `index.js`: Точка входа для запуска циклического анализа.
  - `analysis_engine.js`: Основная логика анализа монет, генерации сигналов и сохранения результатов.
  - Поддиректории: `api`, `models`, `scripts`, `services`, `utils` (содержат вспомогательные модули и сервисы).
  - Многочисленные документационные файлы (например, `README.md`, `SYSTEM_LOGIC.md`).

### 1.3. `market_data_collector`
- **Описание**: Сервис для сбора рыночных данных с различных источников (CoinMarketCap, Bybit, CoinGlass).
- **Файлы**:
  - `market_collector.js`: Основной скрипт для сбора данных.
  - `bybit_api.js`: Модуль для взаимодействия с API Bybit.
  - `coinglass_api.js`: Модуль для взаимодействия с API CoinGlass.
  - `coinmarketcap_api.js`: Модуль для взаимодействия с API CoinMarketCap.

**Проблема**: Хотя сервисы разделены по назначению, их структура и взаимодействие не всегда ясны. Отсутствует единая точка входа для управления всеми компонентами. Также есть избыточность в документации в `smart_money_engine`, что может затруднять ориентацию.

## 2. Анализ кода

### 2.1. `smart_money_service/market_data_normalizer.js`
- **Функциональность**: Скрипт подключается к MongoDB, читает сырые данные из коллекции `raw_coin_market_data`, агрегирует их (например, средняя ставка финансирования, ликвидность, объемы) и сохраняет в коллекцию `coin_market_aggregated`.
- **Связь с MongoDB**: Использует `mongoose` для работы с базой данных, что соответствует твоей цели хранить данные для доступа других сервисов.
- **Проблемы**:
  - Отсутствует обработка ошибок при потере соединения с MongoDB.
  - Нет логирования для отслеживания процесса нормализации в продакшене.

### 2.2. `smart_money_engine/index.js` и `analysis_engine.js`
- **Функциональность (`index.js`)**:
  - Инициализирует сервисы (MongoDB, кэш, трекер сигналов, уведомления и др.).
  - Запускает циклический анализ всех монет с заданным интервалом.
  - Обрабатывает graceful shutdown и ошибки.
- **Функциональность (`analysis_engine.js`)**:
  - Основной цикл анализа: нормализация данных, фильтрация монет, анализ (технические индикаторы, уровни поддержки/сопротивления), генерация сигналов (лонг/шорт), сохранение результатов в MongoDB.
  - Использует сложную систему оценки сигналов и выбора топ-N кандидатов.
- **Связь с MongoDB**: Данные читаются из `coin_market_aggregated` и сохраняются в `analysis_results`.
- **Проблемы**:
  - Код очень сложный и объемный, что затрудняет поддержку.
  - Зависимость от множества сервисов и утилит увеличивает вероятность ошибок.

### 2.3. `market_data_collector/market_collector.js`, `bybit_api.js`, `coinglass_api.js`
- **Функциональность (`market_collector.js`)**:
  - Собирает данные о монетах с CoinMarketCap (для фильтрации по объему и капитализации), Bybit (котировки, история ставок финансирования, книга ордеров) и CoinGlass (рыночные данные).
  - Сохраняет собранные данные в MongoDB в коллекцию `coin_market_data`.
- **Функциональность (`bybit_api.js`)**:
  - Полный API-клиент для Bybit с методами для получения тиков, открытого интереса, истории ставок финансирования, книги ордеров и др.
  - Учитывает ограничения на количество запросов (rate limits).
- **Функциональность (`coinglass_api.js`)**:
  - Клиент для API CoinGlass, используется для получения данных о парах и рынках для конкретной монеты.
- **Связь с MongoDB**: Данные сохраняются для дальнейшей обработки.
- **Проблемы**:
  - Использование CoinMarketCap и CoinGlass увеличивает стоимость (как ты отметил).
  - Отсутствует механизм повторных попыток при сбоях API.

## 3. Общие проблемы
1. **Сложность кода**: Особенно в `smart_money_engine`, где множество модулей и сервисов усложняют поддержку.
2. **Зависимость от дорогих API**: Использование CoinMarketCap и CoinGlass увеличивает затраты.
3. **Отсутствие унификации**: Разные подходы к обработке ошибок, логированию и структуре кода.
4. **Недостаточное логирование**: Затрудняет отладку в продакшене.
5. **Отсутствие документации взаимодействия**: Неясно, как сервисы должны обмениваться данными между собой и с другими частями системы.

## 4. Возможный забытый сервис для технических индикаторов
Я заметил, что в твоем коде уже используется **CoinGlass** (есть файл `coinglass_api.js`), который предоставляет данные о ликвидности, открытом интересе, соотношении лонг/шорт и других индикаторах. Возможно, это тот сервис, который ты забыл. Если нет, я нашел другой популярный сервис — **TAAPI.IO** ([https://taapi.io/](https://taapi.io/)), который предоставляет более 200 технических индикаторов для криптовалютного анализа через API. Это может быть хорошей альтернативой.

## 5. План перестройки

### Шаг 1: Упрощение структуры и кода
- **Объединить сервисы**: Рассмотреть возможность объединения `smart_money_service` и `smart_money_engine` в один сервис для упрощения логики анализа и нормализации.
- **Упростить `analysis_engine.js`**: Разделить сложную логику на меньшие модули с четкими функциями (например, отдельный модуль для анализа индикаторов, отдельный для сигналов).
- **Добавить документацию**: Описать взаимодействие между компонентами и назначение каждого сервиса.

### Шаг 2: Отказ от дорогих API
- **Заменить CoinMarketCap**: Использовать Bybit для фильтрации монет по объему и капитализации (метод `getInstrumentsInfo` уже доступен в `bybit_api.js`).
- **Ограничить использование CoinGlass**: Если это не тот сервис, который ты хочешь использовать, заменить его на TAAPI.IO или другой сервис для технических индикаторов. Если CoinGlass подходит, оставить только ключевые запросы для снижения затрат.

### Шаг 3: Расширение использования Bybit API
- **Сбор всех данных с Bybit**: Использовать существующий модуль `bybit_api.js` для получения всех необходимых данных (цены, объемы, книга ордеров, история ставок финансирования).
- **Добавить кэширование**: Чтобы снизить количество запросов к Bybit, добавить кэш (например, в Redis или локально) для хранения данных, которые не меняются часто.

### Шаг 4: Интеграция с сервисом технических индикаторов
- **Подключить TAAPI.IO или CoinGlass**: Если CoinGlass — это не тот сервис, который ты имел в виду, подключить TAAPI.IO для получения индикаторов (RSI, MACD, Bollinger Bands и др.). Создать отдельный модуль `technical_indicators_api.js` для взаимодействия с этим сервисом.
- **Сохранять индикаторы в MongoDB**: Добавить индикаторы в коллекцию `coin_market_aggregated` для последующего анализа.

### Шаг 5: Улучшение надежности
- **Добавить обработку ошибок**: Включить повторные попытки при сбоях API и обработку ошибок соединения с MongoDB.
- **Улучшить логирование**: Использовать библиотеку `winston` (как в других частях проекта) для структурированного логирования.
- **Добавить мониторинг**: Интегрировать метрики с Prometheus для отслеживания работы сервисов.

### Шаг 6: Тестирование и развертывание
- **Протестировать изменения**: Проверить работу сервисов в изолированной среде (Docker) с использованием Bybit и выбранного сервиса индикаторов.
- **Обновить `docker-compose.yml`**: Убедиться, что все сервисы добавлены с правильными зависимостями (MongoDB, Redis).

## 6. Приоритетные задачи
1. **Подтвердить сервис индикаторов**: Уточнить, является ли CoinGlass тем сервисом, который ты имел в виду. Если нет, рассмотреть TAAPI.IO.
2. **Заменить CoinMarketCap на Bybit**: Начать перестройку `market_collector.js` для использования только Bybit для фильтрации и сбора данных.
3. **Упростить `smart_money_engine`**: Разделить сложную логику на модули для упрощения поддержки.

## 7. Заключение
Текущие сервисы `smart_money_service`, `smart_money_engine` и `market_data_collector` хорошо структурированы для сбора, анализа и хранения рыночных данных в MongoDB, но их сложность и зависимость от дорогих API (CoinMarketCap, CoinGlass) требуют перестройки. Использование Bybit для основного сбора данных и подключение сервиса технических индикаторов (CoinGlass или TAAPI.IO) позволит снизить затраты и сохранить функциональность. Выполнение предложенного плана сделает систему более надежной и готовой к продакшену.

Если у тебя есть вопросы или ты хочешь подтвердить, что CoinGlass — это нужный сервис, дай знать!
