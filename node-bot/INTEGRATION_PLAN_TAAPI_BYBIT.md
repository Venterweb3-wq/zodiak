# План интеграции TAAPI.IO и Bybit для Smart Money сервисов

## 1. Цель интеграции
Целью является упрощение и снижение затрат на сервисы `smart_money_service`, `smart_money_engine` и `market_data_collector` за счет использования Bybit как основного источника рыночных данных и TAAPI.IO для получения технических индикаторов. При этом необходимо сохранить высокий уровень анализа для генерации точных сигналов (лонг/шорт, уровни поддержки/сопротивления) и хранения данных в MongoDB для доступа других сервисов.

## 2. Обзор текущего состояния
- **Bybit API**: Уже реализован в `market_data_collector/bybit_api.js`. Предоставляет данные о ценах, объемах, книге ордеров, ставках финансирования и др.
- **CoinMarketCap и CoinGlass**: Используются для фильтрации монет и дополнительных индикаторов, но увеличивают затраты.
- **MongoDB**: Используется для хранения сырых и агрегированных данных, а также результатов анализа.
- **TAAPI.IO**: Новый сервис для технических индикаторов (RSI, MACD, Bollinger Bands и др.), который заменит часть функциональности CoinGlass и других дорогих API.

## 3. План интеграции

### Шаг 1: Создание модуля для TAAPI.IO
- **Создать файл `taapi_io_api.js` в директории `market_data_collector`**:
  - Реализовать клиент для API TAAPI.IO с методами для получения индикаторов (например, `getRSI`, `getMACD`, `getBollingerBands`).
  - Использовать библиотеку `axios` для HTTP-запросов.
  - Учитывать ограничения на количество запросов (rate limits), как это сделано в `bybit_api.js`.
  - Хранить API-ключ в переменных окружения (например, `TAAPI_IO_API_KEY` в файле `.env`).
- **Пример структуры запроса**:
  ```javascript
  async getRSI(symbol, interval, period = 14) {
    await this.checkRateLimit();
    const response = await this.client.get('/rsi', {
      params: {
        secret: this.apiKey,
        exchange: 'bybit',
        symbol: `${symbol}/USDT`,
        interval: interval,
        period: period
      }
    });
    return response.data;
  }
  ```

### Шаг 2: Обновление `market_data_collector.js` для использования Bybit и TAAPI.IO
- **Отказ от CoinMarketCap**:
  - Использовать метод `getInstrumentsInfo` из `bybit_api.js` для получения списка торгуемых монет на Bybit.
  - Фильтровать монеты по объему и капитализации непосредственно через данные Bybit (например, используя `getTicker` для получения 24-часового объема).
- **Ограничение использования CoinGlass**:
  - Если CoinGlass больше не нужен, удалить вызовы `coinglass.getPairsMarkets` из `processCoin`.
  - Если CoinGlass временно оставлен для специфических данных (например, ликвидности), ограничить запросы только ключевыми монетами.
- **Добавление индикаторов из TAAPI.IO**:
  - В методе `processCoin` добавить вызовы к `taapi_io_api.js` для получения технических индикаторов (RSI, MACD и др.) для каждой монеты.
  - Сохранять индикаторы в MongoDB в коллекцию `coin_market_data` или `coin_market_aggregated` вместе с данными Bybit.

### Шаг 3: Обновление нормализации данных в `smart_money_service/market_data_normalizer.js`
- **Добавить обработку индикаторов TAAPI.IO**:
  - Расширить схему `AggregatedSchema` для включения полей с техническими индикаторами (например, `technical_indicators: { rsi, macd, bollinger_bands }`).
  - При нормализации данных извлекать индикаторы из сырых данных и агрегировать их для анализа.

### Шаг 4: Адаптация анализа в `smart_money_engine/analysis_engine.js`
- **Использовать индикаторы из TAAPI.IO**:
  - Обновить логику анализа для использования данных индикаторов из коллекции `coin_market_aggregated`.
  - Настроить систему оценки сигналов (например, в `analyzeCoin`) для учета RSI, MACD и других индикаторов при определении сигналов лонг/шорт.
- **Улучшить расчет уровней поддержки/сопротивления**:
  - Использовать данные книги ордеров и истории цен из Bybit для более точного определения уровней (уже доступно через `bybit_api.js`).
- **Оптимизировать сложность кода**:
  - Разделить логику анализа на меньшие модули (например, `technical_analysis.js`, `signal_generation.js`) для упрощения поддержки.

### Шаг 5: Улучшение надежности и логирования
- **Добавить обработку ошибок**:
  - В `market_collector.js` и `taapi_io_api.js` добавить повторные попытки при сбоях API.
  - В `market_data_normalizer.js` обработать возможные ошибки соединения с MongoDB.
- **Улучшить логирование**:
  - Использовать библиотеку `winston` для структурированного логирования во всех сервисах.
  - Логировать успешные и неуспешные запросы к Bybit и TAAPI.IO для отладки.

### Шаг 6: Тестирование и развертывание
- **Тестирование**:
  - Протестировать сбор данных с Bybit и TAAPI.IO в изолированной среде (Docker).
  - Проверить точность сигналов (лонг/шорт) на основе новых данных и индикаторов.
- **Развертывание**:
  - Обновить `docker-compose.yml`, добавив переменные окружения для `TAAPI_IO_API_KEY` и убедившись, что все сервисы правильно настроены с зависимостями (MongoDB, Redis).

## 4. Приоритетные задачи
1. **Создать модуль `taapi_io_api.js`**: Реализовать клиент для TAAPI.IO с учетом rate limits и хранением API-ключа в переменных окружения.
2. **Обновить `market_data_collector.js`**: Заменить CoinMarketCap на Bybit для фильтрации монет и добавить получение индикаторов из TAAPI.IO.
3. **Проверить качество анализа**: Убедиться, что новые индикаторы из TAAPI.IO обеспечивают точные сигналы в `analysis_engine.js`.

## 5. Ожидаемые результаты
- **Снижение затрат**: Отказ от CoinMarketCap и ограничение использования CoinGlass уменьшат расходы на API.
- **Упрощение системы**: Использование только Bybit и TAAPI.IO сделает систему более компактной и понятной.
- **Качество анализа**: Технические индикаторы из TAAPI.IO (RSI, MACD, Bollinger Bands и др.) в сочетании с данными Bybit обеспечат точные сигналы лонг/шорт и уровни поддержки/сопротивления.

## 6. Заключение
Интеграция Bybit и TAAPI.IO позволит упростить сервисы Smart Money, сохранив высокий уровень анализа. Данные с Bybit обеспечат основу для фильтрации монет и рыночной информации, а TAAPI.IO предоставит необходимые технические индикаторы. Выполнение этого плана сделает систему более эффективной и готовой к продакшену.

Если ты готов начать реализацию или у тебя есть дополнительные пожелания, дай знать!
