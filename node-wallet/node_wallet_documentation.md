# Документация микросервиса `node-wallet`

## Обзор

Микросервис `node-wallet` представляет собой набор приложений на Node.js, разработанных для выполнения операций с криптовалютными кошельками в рамках проекта "my-platform". Этот микросервис отвечает за генерацию кошельков, мониторинг депозитов, обработку выплат и взаимодействие с блокчейнами (TRC20, Arbitrum, BEP20). Он интегрируется с Django-бэкендом (ядром системы и инвестиционными приложениями) через HTTP API и Redis-каналы.

## Структура проекта

Директория `node-wallet` содержит следующие ключевые файлы и папки:

- **`/services/`**: Содержит код для API-сервиса, движка выплат и низкоуровневых блокчейн-сервисов.
  - `api.js`: Основной файл API-сервиса для генерации кошельков.
  - `api_service.js`: Дополнительные функции для API.
  - `payout_engine.js`: Движок для оркестрации блокчейн-транзакций (выплат и свипов).
  - `tron.js`: Низкоуровневые функции для взаимодействия с сетью TRON (TRC20).
  - `evmService.js`: Низкоуровневые функции для EVM-совместимых сетей (Arbitrum, BSC/BEP20).
- **`/workers/`**: Содержит воркеры для фоновых задач.
  - `deposit_monitor.js`: Воркер для мониторинга депозитов на временных кошельках.
  - `payout_worker.js`: Воркер для обработки выплат (ежедневных начислений и вывода средств).
- **`/utils/`**: Утилиты для поддержки функциональности.
  - `crypto.js`: Функции для шифрования и расшифровки приватных ключей (AES-256-CBC).
  - `wallet_generator.js`: Функции для генерации адресов и приватных ключей.
- **`README.md`**: Основная документация с описанием компонентов и инструкциями по запуску.
- **`API.md`**: Документация API-сервиса с описанием эндпоинтов.
- **`Dockerfile`**: Файл для сборки Docker-образа микросервиса.
- **`package.json`**: Файл с зависимостями и скриптами для Node.js.

## Компоненты микросервиса

### 1. API Сервис Кошельков (`services/api.js`)

- **Назначение**: Предоставляет внутренний HTTP API для генерации новых криптовалютных кошельков.
- **Основные функции**:
  - Генерация адресов и приватных ключей для сетей TRC20 (Tron), Arbitrum (ETH), BEP20 (BSC).
  - Шифрование приватных ключей перед их возвратом вызывающей стороне (Django).
- **Запуск**: Запускается как отдельный сервис в Docker. Команда по умолчанию в `Dockerfile` (`CMD ["node", "services/api.js"]`).
- **Эндпоинты** (подробности в `API.md`):
  - `GET /healthz`: Проверка работоспособности сервиса.
    - **Ответ**: `{ "status": "ok" }`
  - `POST /generate_wallet`: Генерация нового кошелька для указанной сети.
    - **Заголовки**: `Authorization: Bearer <API_TOKEN>`, `Content-Type: application/json`
    - **Тело запроса**: `{ "network": "ARBITRUM" | "TRC20" }`
    - **Ответ**: `{ "address": "string", "encryptedPrivateKey": "string", "network": "string" }`
    - **Ошибки**: `400 Bad Request`, `403 Forbidden`, `429 Too Many Requests`, `500 Internal Server Error`
- **Ограничения**: API ограничен 10 запросами в минуту с одного IP-адреса.
- **Безопасность**: Все запросы требуют авторизации через Bearer token, приватные ключи шифруются, входные данные валидируются.
- **Взаимодействие с ядром**: Используется Django для создания временных кошельков (например, через эндпоинт `/api/flexible_arbitrage/create-deposit/` в инвестиционных приложениях).

### 2. Воркер Обработки Выплат (`workers/payout_worker.js`)

- **Назначение**: Отвечает за обработку запросов на выплаты (ежедневные начисления и вывод средств пользователями).
- **Основные функции**:
  - Подписывается на Redis-каналы (например, `payouts_cross_arbitrage`), которые определяются динамически через запрос к эндпоинту Django `/api/auth/strategies/list/`.
  - При получении сообщения (типы `daily_payout_cross_arbitrage` или `withdraw_full_balance_cross_arbitrage`):
    - Вызывает `services/payout_engine.js` для выполнения реальных блокчейн-транзакций по отправке USDT.
    - Обновляет статус соответствующей записи (`DailyPayout` или `WithdrawalRequest`) в Django через PATCH-запросы, указывая результат транзакции (хеш, успех/ошибка).
- **Запуск**: Запускается как отдельный сервис в Docker с командой `node workers/payout_worker.js` (переопределяется в `docker-compose.yml`).
- **Взаимодействие с ядром и инвестприложениями**: Получает команды на выплаты через Redis-каналы, настроенные для конкретных приложений (`flexible_arbitrage`, `inter_exchange`, `cross_arbitrage`). После выполнения транзакции обновляет статус через эндпоинты, такие как `/api/flexible_arbitrage/notify-payout/`.

### 3. Воркер Мониторинга Депозитов (`workers/deposit_monitor.js`)

- **Назначение**: Автоматически отслеживает поступления USDT на временные кошельки пользователей и инициирует процесс их сбора (свипа) на центральные кошельки.
- **Основные функции**:
  - Периодически запрашивает у Django список временных кошельков, ожидающих депозита (эндпоинт `/api/investments/temp-wallets/pending-deposit/`).
  - Проверяет баланс USDT на этих кошельках в сетях TRC20, Arbitrum, BEP20.
  - При обнаружении депозита:
    1. Уведомляет Django о поступлении средств (`/api/investments/temp-wallets/notify-deposit/`).
    2. Запрашивает зашифрованный приватный ключ для данного кошелька (`/api/investments/temp-wallets/<id>/encrypted-key/`).
    3. Расшифровывает приватный ключ.
    4. Вызывает `services/payout_engine.js` для выполнения свипа:
       - Сначала пополняет временный кошелек нативной валютой (TRX, ETH, BNB) для покрытия комиссии (средства берутся с центральных кошельков, ключи от которых указаны в `.env`).
       - Затем переводит все USDT с временного кошелька на центральный кошелек.
    5. Уведомляет Django о результате операции свипа (`/api/investments/temp-wallets/notify-sweep/`), включая хеши транзакций и возможные ошибки.
- **Запуск**: Запускается как отдельный сервис в Docker с командой `node workers/deposit_monitor.js`.
- **Взаимодействие с ядром и инвестприложениями**: Взаимодействует с эндпоинтами инвестиционных приложений (например, `/api/flexible_arbitrage/notify-deposit/`), чтобы сообщить о депозитах и свипах, обновляя статус временных кошельков (`TemporaryWallet`) и депозитов (`InvestmentDeposit`).

### 4. Движок Платежей (`services/payout_engine.js`)

- **Назначение**: Центральный сервис для оркестрации выполнения блокчейн-транзакций (обычные выплаты и свипы).
- **Основные функции**:
  - `handlePayoutRequest`: Проверяет баланс основного кошелька, затем вызывает соответствующий сервис (`tronService.js` или `evmService.js`) для отправки USDT получателю.
  - `handleSweepRequest`: Координирует процесс свипа. Сначала вызывает `prepareWalletForSweep...` (в `tronService.js` или `evmService.js`) для пополнения временного кошелька нативной валютой для комиссии, затем вызывает `sweep...` для перевода USDT.
- **Запуск**: Не запускается как отдельный процесс, используется другими модулями (`payout_worker.js`, `deposit_monitor.js`).
- **Взаимодействие**: Служит связующим звеном между воркерами и низкоуровневыми блокчейн-сервисами.

### 5. Блокчейн Сервисы (`services/tron.js`, `services/evmService.js`)

- **Назначение**: Предоставляют низкоуровневые функции для взаимодействия с блокчейнами TRON и EVM-совместимыми сетями (Arbitrum, BSC/BEP20).
- **Основные функции**:
  - Получение балансов (нативной валюты и USDT).
  - Отправка нативной валюты.
  - Отправка токенов USDT.
  - Подготовка кошельков к свипу (пополнение нативной валютой).
  - Свип токенов USDT.
- **Используемые библиотеки**: `tronweb` для TRON, `ethers` для EVM-сетей.
- **Запуск**: Не запускаются как отдельные процессы, используются движком платежей.
- **Взаимодействие**: Выполняют конкретные транзакции в разных сетях по запросу от `payout_engine.js`.

### 6. Утилиты (`utils/`)

- **`crypto.js`**:
  - **Назначение**: Функции для AES-256-CBC шифрования и расшифровки приватных ключей.
  - **Используемые переменные**: `WALLET_ENCRYPTION_KEY` из `.env` (32-байтный HEX-ключ).
  - **Взаимодействие**: Используется API-сервисом для шифрования ключей и воркерами для расшифровки перед выполнением транзакций.
- **`wallet_generator.js`**:
  - **Назначение**: Функции для генерации адресов и приватных ключей для различных сетей.
  - **Взаимодействие**: Используется API-сервисом для создания новых кошельков.

## Логика работы микросервиса

1. **Генерация кошельков**:
   - Django (например, из приложения `flexible_arbitrage`) вызывает эндпоинт `/generate_wallet` сервиса `api.js` для создания временного кошелька.
   - Сервис возвращает адрес и зашифрованный приватный ключ, которые сохраняются в базе данных Django (например, в модели `TemporaryWallet`).

2. **Мониторинг депозитов**:
   - Воркер `deposit_monitor.js` периодически запрашивает у Django список временных кошельков, ожидающих депозита, через эндпоинт `/api/investments/temp-wallets/pending-deposit/`.
   - При обнаружении депозита уведомляет Django через `/api/investments/temp-wallets/notify-deposit/` и выполняет свип на центральный кошелек, после чего сообщает результат через `/api/investments/temp-wallets/notify-sweep/`.

3. **Обработка выплат**:
   - Воркер `payout_worker.js` подписывается на Redis-каналы, настроенные для инвестиционных приложений (каналы определяются динамически через `/api/auth/strategies/list/`).
   - При получении команды на выплату (ежедневную или вывод средств) выполняет транзакцию через `payout_engine.js` и обновляет статус в Django через соответствующий эндпоинт (например, `/api/flexible_arbitrage/notify-payout/`).

## Взаимодействие с ядром и инвестиционными приложениями

### С ядром системы (`core`)

- **Динамическая конфигурация**: Микросервис получает конфигурацию стратегий через эндпоинт `/api/auth/strategies/list/`, что позволяет динамически определять Redis-каналы и API-префиксы для взаимодействия с инвестиционными приложениями.
- **Авторизация**: Запросы к Django API авторизуются через токен `NODE_WORKER_API_TOKEN`, определенный в переменных окружения.

### С инвестиционными приложениями (`flexible_arbitrage`, `inter_exchange`, `cross_arbitrage`)

- **Эндпоинты для депозитов**:
  - Микросервис взаимодействует с эндпоинтами, специфичными для каждого приложения, например:
    - `/api/flexible_arbitrage/notify-deposit/` для уведомления о депозите.
    - `/api/flexible_arbitrage/notify-sweep/` для уведомления о свипе.
  - Это обновляет статус моделей `TemporaryWallet` и `InvestmentDeposit` в базе данных Django.
- **Эндпоинты для выплат**:
  - Для уведомления о результатах выплат используются эндпоинты вроде `/api/flexible_arbitrage/notify-payout/`, что обновляет статус `DailyPayout` или `WithdrawalRequest`.
- **Redis-каналы**: Для обработки выплат воркер подписывается на каналы, связанные с конкретными приложениями (например, `payouts_flexible_arbitrage`), получая команды на выполнение транзакций.

## Переменные окружения

Для работы микросервиса необходимо определить переменные окружения в файле `.env`. Основные категории:

- **Для API-сервиса кошельков**:
  - `PORT`: Порт для API-сервиса.
  - `INTERNAL_API_TOKEN`: Токен для авторизации запросов от Django.
  - `TRON_API_KEY`: API-ключ для TronGrid.
- **Для воркеров и блокчейн-сервисов**:
  - `DJANGO_API_BASE_URL`: Базовый URL для Django API.
  - `NODE_WORKER_API_TOKEN`: Токен для авторизации воркеров в Django API.
  - `DJANGO_APP_API_PREFIX`: Префикс для эндпоинтов Django.
  - `DEPOSIT_MONITOR_INTERVAL_MS`: Интервал проверки депозитов.
  - `MIN_USDT_DEPOSIT_TO_PROCESS`: Минимальная сумма USDT для обработки депозита.
- **Для шифрования**:
  - `WALLET_ENCRYPTION_KEY`: 32-байтный HEX-ключ для шифрования/расшифровки приватных ключей.
- **Для сетей TRON и EVM**:
  - URL-адреса нод, адреса и приватные ключи центральных кошельков, адреса контрактов USDT, минимальные балансы и суммы для комиссий.

Полный список переменных окружения приведен в файле `README.md`.

## Сборка и запуск через Docker

Все сервисы (`api`, `payout_worker`, `deposit_monitor`) собираются и запускаются с использованием Docker и Docker Compose.

- **`Dockerfile`**: Определяет процесс сборки образа Node.js приложения с этапами `builder` и финального образа, включая настройку пользователя `appuser` для безопасности и `HEALTHCHECK` для проверки состояния API-сервиса.
- **`docker-compose.yml`**: Находится в корне проекта и определяет сервисы `node-payout-worker`, `node-deposit-monitor` и, возможно, сервис для `api.js`. Указывает команды для запуска воркеров и подключение переменных окружения.

**Команды для запуска**:
- Сборка и запуск: `docker-compose up --build -d`
- Остановка: `docker-compose down`

## Архитектура и особенности

- **Модульность**: Микросервис разделен на независимые компоненты (API, воркеры, блокчейн-сервисы), что упрощает поддержку и масштабирование.
- **Динамическая конфигурация**: Воркеры получают список активных стратегий и их параметры (`api_prefix`, `redis_channel`) из Django через `/api/auth/strategies/list/`, что позволяет добавлять новые инвестиционные стратегии без изменения кода `node-wallet`.
- **Безопасность**: Приватные ключи шифруются, запросы авторизуются, входные данные валидируются, а Docker-контейнеры запускаются от имени пользователя без root-прав.

## Возможные улучшения

1. **Расширение документации API**: Добавить примеры запросов и ответов для всех эндпоинтов, включая возможные ошибки.
2. **Мониторинг и логирование**: Улучшить логирование операций (депозитов, свипов, выплат) для упрощения отладки и мониторинга.
3. **Оптимизация производительности**: Рассмотреть возможность параллельной обработки депозитов и выплат для повышения скорости.
4. **Поддержка новых сетей**: Добавить поддержку дополнительных блокчейн-сетей для расширения функциональности.
5. **Автоматизация тестирования**: Разработать тесты для проверки корректности генерации кошельков, шифрования ключей и выполнения транзакций.

## Заключение

Микросервис `node-wallet` является критически важным компонентом системы "my-platform", обеспечивая низкоуровневые операции с криптовалютными кошельками и блокчейнами. Он тесно интегрирован с ядром системы через динамическую конфигурацию и с инвестиционными приложениями через их API-эндпоинты и Redis-каналы, что позволяет эффективно обрабатывать депозиты, свипы и выплаты.

Если у вас есть дополнительные вопросы или пожелания по улучшению функциональности микросервиса, дайте знать!
