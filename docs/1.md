# Журнал изменений: Интеграция flexible_arbitrage и обновление Node.js

## 1. Обновление настроек `django-axes` (Django)

*   **Проблема:** Настройка `AXES_LOCK_OUT_BY_COMBINATION_USER_AND_IP` устарела.
*   **Решение:**
    *   В `django/myproject/settings/base.py` заменено `AXES_LOCK_OUT_BY_COMBINATION_USER_AND_IP = True` на `AXES_LOCKOUT_PARAMETERS = ['username', 'ip_address']`.
    *   В `django/myproject/settings/prod.py` добавлены полные настройки для `django-axes`, включая:
        *   `AXES_FAILURE_LIMIT` (чтение из `.env`)
        *   `AXES_COOLOFF_TIME` (чтение из `.env`)
        *   `AXES_RESET_ON_SUCCESS` (чтение из `.env`)
        *   `AXES_HANDLER` (чтение из `.env`)
        *   `AXES_LOCKOUT_PARAMETERS` (чтение из `.env`)
        *   `axes` добавлен в `INSTALLED_APPS`.
        *   `axes.middleware.AxesMiddleware` добавлен в `MIDDLEWARE`.
        *   `AUTHENTICATION_BACKENDS` обновлен для включения `axes.backends.AxesStandaloneBackend`.
    *   Чтение `AXES_LOCKOUT_PARAMETERS` из `.env` также было добавлено в `django/myproject/settings/base.py` (если он используется для этих целей, в `prod.py` это точно сделано).

## 2. Создание нового Django-приложения `flexible_arbitrage`

*   **Цель:** Упрощенная версия `cross_arbitrage` с немедленным начислением процентов каждые 10 минут и выводом в любое время с комиссией.
*   **Созданные файлы и структура:**
    *   Директория: `django/myproject/apps/flexible_arbitrage/`
    *   Базовые файлы: `__init__.py`, `admin.py`, `apps.py`, `models.py`, `serializers.py`, `tasks.py`, `urls.py`, `views.py`, `migrations/__init__.py`.
*   **Ключевые компоненты:**
    *   **`models.py`**:
        *   `FlexibleInvestmentAccount`: Баланс, сеть, время последнего начисления.
        *   `FlexiblePayout`: История начислений.
        *   `FlexibleDeposit`: История пополнений.
        *   `FlexibleWithdrawal`: История выводов (с комиссией).
        *   `FlexibleTemporaryWallet`: Для временных депозитных адресов, со статусами и связью с `FlexibleDeposit`.
        *   `NETWORK_CHOICES` (TRC20, BEP20, Arbitrum).
    *   **`admin.py`**: Регистрация моделей.
    *   **`tasks.py`**:
        *   Задача Celery `generate_flexible_payouts` для начисления процентов каждые 10 минут.
        *   `FLEXIBLE_DAILY_INTEREST_RATE` и `INTEREST_RATE_PER_INTERVAL`.
    *   **`serializers.py`**: Для создания депозита/вывода, отображения статистики, истории, работы с `FlexibleTemporaryWallet`.
    *   **`views.py`**: API-эндпоинты для:
        *   Запроса временного кошелька (`RequestFlexibleTemporaryWalletView`).
        *   Уведомления о депозите от Node.js (`NotifyFlexibleDepositView`).
        *   Уведомления о статусе свипа от Node.js (`NotifyFlexibleSweepStatusView`).
        *   Получения списка ожидающих кошельков для Node.js (`PendingFlexibleDepositWalletsListView`).
        *   Получения зашифрованного ключа для Node.js (`FlexibleTemporaryWalletEncryptedKeyView`).
        *   Вывода средств (`FlexibleWithdrawView`).
        *   Статистики и истории.
    *   **`urls.py`**: Настроены URL-пути.
*   **Интеграция:**
    *   Приложение добавлено в `INSTALLED_APPS` в `settings/base.py` и `settings/prod.py`.
    *   Задача `generate_flexible_payouts` добавлена в `CELERY_BEAT_SCHEDULE` в `settings/base.py` и `settings/prod.py`.
    *   URL-пути подключены к корневому `django/myproject/urls.py` под префиксом `api/flexible/`.

## 3. Адаптация `node-wallet` для поддержки `flexible_arbitrage`

*   **Цель:** Обеспечить работу `node-wallet` (особенно `deposit_monitor.js`) с новым модулем `flexible_arbitrage` наряду с существующим `cross_arbitrage`.
*   **Изменения в `node-wallet/workers/deposit_monitor.js`:**
    *   Добавлена переменная окружения `DJANGO_FLEXIBLE_ARBITRAGE_API_PREFIX`.
    *   Функции взаимодействия с Django (`fetchPendingDepositWallets`, `notifyDjangoOfDeposit`, `fetchEncryptedKeyFromDjango`, `notifyDjangoOfSweepStatus`) модифицированы для принятия `appType` и использования соответствующего префикса API Django.
    *   `fetchPendingDepositWallets` теперь добавляет `appType` к каждому кошельку.
    *   Основной цикл `monitorDeposits` запрашивает кошельки для обоих приложений (`cross_arbitrage` и `flexible_arbitrage`) и обрабатывает их единым образом через `processWallet`.
    *   Скорректированы поля в payload для `notifyDjangoOfDeposit` и `notifyDjangoOfSweepStatus` для совместимости с сериализаторами обоих Django-модулей.
*   **Изменения в `node-wallet/services/tron.js`:**
    *   Переменная для адреса сбора средств была уточнена до `SWEEP_DESTINATION_ADDRESS_TRON` и читается из `process.env.SWEEP_DESTINATION_ADDRESS_TRON` (или `TRON_MAIN_WALLET_ADDRESS` по умолчанию). Функция `sweepTRC20` использует эту переменную.
*   **Изменения в `node-wallet/services/evmService.js`:**
    *   Сервис уже использовал `EVM_SWEEP_DESTINATION_ADDRESS` из `process.env`, что соответствует нашим требованиям для сбора средств с EVM-кошельков. Изменений не потребовалось.
*   **`node-wallet/services/payout_engine.js`:**
    *   Выяснено, что `payout_engine.js` не требует `appType` для выбора кошелька назначения при свипе, так как `tronService.js` и `evmService.js` сами определяют целевой кошелек на основе переменных окружения `SWEEP_DESTINATION_ADDRESS_TRON` и `EVM_SWEEP_DESTINATION_ADDRESS`. Комментарий TODO в `payout_engine.js` был удален.
*   **`node-wallet/services/api_service.js` и `api.js` (сервер API генерации кошельков):**
    *   Функция `generateWallet` в `api_service.js` принимает `network` и возвращает `address` и `encryptedPrivateKey`.
    *   Сервер API в `api.js` использует переменные окружения `PORT` (для порта) и `INTERNAL_API_TOKEN` (для авторизации запросов от Django). Django, в свою очередь, должен отправлять запросы на этот API с указанным токеном.
    *   `node-wallet/utils/crypto.js` использует `WALLET_ENCRYPTION_KEY` из `.env` для шифрования/дешифрования.

## 4. Настройки взаимодействия Django <-> Node.js

*   **Django Settings (`prod.py` и `base.py`):**
    *   Добавлены переменные для конфигурации вызова Node.js API генерации кошельков:
        *   `NODE_WALLET_API_HOST`
        *   `NODE_WALLET_API_PORT`
        *   `NODE_WALLET_INTERNAL_API_TOKEN` (токен, который Django использует для авторизации в Node.js API генерации кошельков)
    *   Добавлена/унифицирована переменная для токена, который Node.js воркеры используют для авторизации в Django API:
        *   `NODE_WORKER_API_TOKEN`
*   **Django Views:**
    *   Класс разрешений `IsNodeWorker` в `cross_arbitrage/views.py` и `flexible_arbitrage/views.py` унифицирован:
        *   Ожидает `Authorization: Bearer <token>`.
        *   Использует `settings.NODE_WORKER_API_TOKEN` для проверки.
    *   `flexible_arbitrage/views.py -> RequestFlexibleTemporaryWalletView`:
        *   Реализован реальный вызов Node.js API (`/generate_wallet`) с использованием `settings.NODE_WALLET_API_HOST`, `settings.NODE_WALLET_API_PORT` и `settings.NODE_WALLET_INTERNAL_API_TOKEN`.
        *   Добавлена обработка ошибок и таймаутов при вызове Node.js API.
    *   `cross_arbitrage/views.py -> RequestTemporaryWalletView`:
        *   Уже содержал логику вызова Node.js API, которая послужила примером. Использует `settings.NODEJS_WALLET_API_URL` и `settings.NODEJS_INTERNAL_API_TOKEN` (необходимо проверить, что эти имена соответствуют добавленным в `prod.py`, или унифицировать их использование). *Примечание: Мы добавили `NODE_WALLET_API_HOST`, `NODE_WALLET_API_PORT`, `NODE_WALLET_INTERNAL_API_TOKEN` в `prod.py`.*

## 5. Конфигурационный файл `.env.example`

*   Создан подробный пример файла `.env.example`, включающий все необходимые переменные для Django и Node.js сервисов, с комментариями:
    *   Настройки базы данных PostgreSQL.
    *   Основные настройки Django (Secret Key, Debug, Allowed Hosts).
    *   Настройки Email.
    *   Настройки Redis и Celery.
    *   Конфигурация для сетей TRON и EVM (URL нод, адреса контрактов, основные кошельки, адреса для сбора средств, суммы для комиссий).
    *   Пороги балансов USDT.
    *   Настройки взаимодействия Node.js <-> Django (URL API Django, токен для воркеров).
    *   Настройки API генерации кошельков Node.js (порт, токен для Django, ключ шифрования).
    *   Настройки монитора депозитов Node.js (префиксы API Django-приложений, интервал, минимальная сумма).
    *   Настройки Django Axes.

## Рекомендации по именованию переменных в `.env` для Node.js `api.js`:

*   Для ясности рекомендуется, чтобы имена переменных в `.env` файле совпадали с тем, как они используются в коде Node.js (`api.js`):
    *   Вместо `NODE_WALLET_PORT` в `.env` использовать `PORT` (если не конфликтует).
    *   Вместо `NODE_WALLET_INTERNAL_API_TOKEN` в `.env` использовать `INTERNAL_API_TOKEN` (если не конфликтует).
    *   Если есть конфликты, то в `api.js` следует изменить `process.env.PORT` на `process.env.NODE_WALLET_PORT` и `process.env.INTERNAL_API_TOKEN` на `process.env.NODE_WALLET_INTERNAL_API_TOKEN`.

---

Этот документ должен помочь отследить проделанную работу. Не забудьте внимательно проверить все конфигурационные файлы и переменные окружения на соответствие и актуальность.