# Статус настройки продакшен-окружения и будущие шаги

Данный документ описывает текущее состояние конфигурации для запуска проекта в продакшен-окружении с использованием Docker и Nginx, а также дальнейшие шаги по улучшению и завершению настройки.

## Текущее состояние (Настроено)

### 1. Docker-конфигурация (`django/Dockerfile`)
- Используется базовый образ `python:3.11-slim-buster`.
- Установлены переменные окружения `PYTHONDONTWRITEBYTECODE=1`, `PYTHONUNBUFFERED=1`.
- **`DJANGO_SETTINGS_MODULE` жестко установлен на `myproject.settings.prod`**.
- Устанавливаются системные зависимости (`build-essential`, `libpq-dev`).
- Зависимости Python устанавливаются из `requirements.txt` (предполагается, что версии зафиксированы).
- Создается непривилегированный пользователь `django_user`, от имени которого запускается приложение.
- **Автоматический сбор статики**: `python manage.py collectstatic --noinput --clear` выполняется при сборке образа. Статика собирается в `/app/static`.
- **Автоматическое применение миграций**: Используется `entrypoint.sh`, который выполняет `python manage.py migrate --noinput` перед запуском Gunicorn.
- Gunicorn запускается с 3 воркерами (настраиваемо).

### 2. Исключения Docker (`django/.dockerignore`)
- Создан файл `.dockerignore` для исключения ненужных файлов и директорий из Docker-контекста и образа, что оптимизирует сборку и уменьшает размер образа.

### 3. Настройки Django для продакшена (`django/myproject/settings/prod.py`)
- Создан файл `prod.py`, который наследуется от `base.py`.
- `DEBUG = False`.
- `ALLOWED_HOSTS` и `SECRET_KEY` должны быть установлены через переменные окружения.
- Настройки базы данных, Email, reCAPTCHA, URL внешних сервисов (Node.js) и другие критичные параметры берутся из переменных окружения.
- Настроены параметры безопасности для HTTPS (`CSRF_COOKIE_SECURE`, `SESSION_COOKIE_SECURE`, `SECURE_SSL_REDIRECT` и т.д.) с возможностью управления через переменные окружения.

### 4. Docker Compose (`docker-compose.yml`)
- **Сервисы**: `db` (PostgreSQL), `redis`, `django`, `celery`, `celery-beat`, `flower`, `node-payout-worker`, `node-deposit-monitor`, `node-api`, `nginx`.
- **БД и Redis**:
    - Используются официальные образы.
    - Данные PostgreSQL сохраняются в именованном томе `postgres_data`.
    - **Порты `db` и `redis` не публикуются наружу** для повышения безопасности.
- **Django-сервисы (`django`, `celery`, `celery-beat`):**
    - Собираются из `django/Dockerfile`.
    - **Монтирование локального кода удалено/закомментировано** (код используется из образов).
    - Используется `env_file: .env` для переменных окружения.
    - **Именованный том `django_media`** используется для хранения медиафайлов (`/app/media`).
    - **Именованный том `django_static_files`** используется для статических файлов (`/app/static`), которые собираются `collectstatic` и раздаются Nginx.
- **Node.js сервисы:**
    - Собираются из контекста `./node-wallet`.
    - **Монтирование локального кода удалено/закомментировано.**
    - Используется `env_file: .env`.
- **Nginx (`nginx` сервис):**
    - Используется образ `nginx:stable-alpine`.
    - **Публикует порт `80:80`** (порт `443` для SSL пока закомментирован).
    - Конфигурация Nginx (`nginx/default.conf`) монтируется в `/etc/nginx/conf.d/default.conf`.
    - **Раздает статику** из тома `django_static_files` (смонтирован read-only).
    - **Раздает медиафайлы** из тома `django_media` (смонтирован read-only).
    - **Проксирует запросы к `django:8000`** (для `/api/` и `/`, согласно текущей конфигурации `nginx/default.conf`).
    - Зависит от `django` и `node-api`.
    - **Порты `django` (8000) и `node-api` (3001) больше не публикуются наружу** в `docker-compose.yml`.

### 5. Конфигурация Nginx (`nginx/default.conf`)
- Настроено прослушивание порта 80.
- Настроена раздача статики и медиафайлов Django.
- Настроено проксирование запросов на сервис `django`.
- Присутствуют закомментированные секции для проксирования на `node-api`.
- `client_max_body_size` установлен в `20M`.

## Необходимые действия и будущие шаги

### 1. Завершение конфигурации Nginx (`nginx/default.conf`)
- **`server_name`**: **Обязательно** обновить на реальный домен(ы) продакшен-сервера.
- **Структура URL Django**: Проверить и при необходимости скорректировать `location` блоки для Django (например, использование только `location /` или более специфичных `location /api/`, `location /admin/` и т.д.).
- **Проксирование Node.js API**: Если требуется, раскомментировать и настроить `location` блок для `node-api`. Если нет, убедиться, что прямой доступ к `node-api` (если он нужен) настроен корректно (например, публикация его порта в `docker-compose.yml`).
- **Исправление `wsgi.py`:** ~~Критическая проблема с пустым файлом `wsgi.py` была исправлена.~~ (Выполнено 01-08-2024)

### 2. Настройка SSL (HTTPS) для Nginx
- **Получение SSL-сертификатов**: Использовать Let's Encrypt (Certbot) или другой центр сертификации для получения сертификатов для вашего домена.
- **Конфигурация Nginx для SSL**:
    - Настроить Nginx на прослушивание порта 443.
    - Указать пути к SSL-сертификату и приватному ключу.
    - Настроить параметры SSL (шифры, протоколы и т.д.).
    - Настроить автоматический редирект с HTTP на HTTPS.
- **Монтирование сертификатов в Nginx-контейнер**: Обновить `docker-compose.yml` для монтирования директории с сертификатами.
- **Автоматизация обновления сертификатов Certbot**: Настроить cron-задачу или сервис для автоматического продления SSL-сертификатов.

### 3. Переменные окружения (`.env` файл)
- **Тщательно проверить и заполнить `.env` файл** всеми необходимыми значениями для продакшена.
- **Особое внимание**: `DJANGO_SECRET_KEY` (должен быть уникальным и очень сложным), `DJANGO_ALLOWED_HOSTS` (должен включать ваш домен и, возможно, IP), все ключи API, данные для подключения к внешним сервисам, настройки email.
- **Безопасность `.env`**: Убедиться, что файл `.env` **не попадает в систему контроля версий** и надежно хранится на продакшен-сервере. Рассмотреть использование систем управления секретами (например, HashiCorp Vault, AWS Secrets Manager, Docker Secrets) для более безопасного управления чувствительными данными.
- **Корректность `.env`**: ~~Проблема с некорректной переменной `DJANGO_SETTINGS_MODULE` в `.env` была исправлена.~~ (Выполнено 01-08-2024)

### 4. Резервное копирование
- **База данных**: Настроить регулярное резервное копирование данных PostgreSQL.
- **Медиафайлы**: Настроить резервное копирование тома `django_media`.
- **Redis**: Если Redis используется для хранения персистентных данных (а не только как кэш или брокер сообщений), рассмотреть необходимость его резервного копирования.

### 5. Мониторинг и Логирование
- **Логирование**: Настроить сбор и централизованное хранение логов всех сервисов (Django, Nginx, Celery, Node.js и т.д.). Рассмотреть инструменты типа ELK Stack (Elasticsearch, Logstash, Kibana) или Grafana Loki.
- **Мониторинг**: Настроить мониторинг состояния серверов, контейнеров, производительности приложений (CPU, память, время ответа и т.д.). Рассмотреть Prometheus, Grafana, Sentry (для ошибок Django/Python).
- Сервис `flower` уже добавлен для мониторинга Celery.
- **Интеграция мониторинга**: ~~В проект интегрированы Sentry для отслеживания ошибок и Prometheus для сбора метрик. В `docker-compose.yml` добавлены сервисы `prometheus` и `grafana` для полноценного мониторинга.~~ (Выполнено 01-08-2024)

### 6. Тестирование
- Провести полное регрессионное тестирование всего функционала в окружении, максимально приближенном к продакшену.
- Провести нагрузочное тестирование для определения пределов производительности и узких мест.

### 7. Оптимизация Gunicorn
- Настроить количество воркеров Gunicorn (`--workers`) в `django/Dockerfile` (или через переменную окружения в `docker-compose.yml`) в соответствии с ресурсами CPU продакшен-сервера (обычно `(2 * CPU_CORES) + 1`).
- Рассмотреть использование асинхронных воркеров (например, `gthread` или на базе `uvicorn` для ASGI, если приложение это поддерживает), если есть много I/O bound операций.

### 8. Безопасность
- Регулярно обновлять все зависимости (ОС, Python, Django, Nginx, Node.js, пакеты).
- Провести аудит безопасности конфигураций и кода.
- Настроить фаервол на сервере.
- Следовать лучшим практикам безопасности Django и веб-приложений.
- **Рефакторинг `cross_arbitrage`**: ~~Проведен рефакторинг для поддержки мультисетевых счетов, унифицировав логику с `flexible_arbitrage`.~~ (Выполнено 01-08-2024)
- **Исправление зависимостей**: ~~Некорректные версии в `requirements.txt` были исправлены.~~ (Выполнено 01-08-2024)
- **Рефакторинг Node.js**: ~~Воркеры `node-wallet` были переведены на динамическую конфигурацию через "Реестр стратегий" в Django для поддержки масштабирования.~~ (Выполнено 01-08-2024)

### 9. Документация
- Поддерживать актуальной документацию по развертыванию, конфигурации и обслуживанию проекта. 
- **Обновление документации API**: ~~Документация (`API_DOCUMENTATION.md`, `frontend_api_endpoints_2024-07-31.md`) была обновлена в соответствии с проведенным рефакторингом.~~ (Выполнено 01-08-2024)
- **Обновление руководств**: ~~`README.md` для `node-wallet` и `LOCAL_TESTING_GUIDE.md` обновлены для отражения новой динамической архитектуры.~~ (Выполнено 01-08-2024) 