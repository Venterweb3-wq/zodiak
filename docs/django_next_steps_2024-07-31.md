# План дальнейших шагов для Django проекта (31-07-2024)

## I. Критические исправления и улучшения инфраструктуры

1.  **Исправить `django/myproject/wsgi.py`:**
    *   **Задача:** Добавить стандартный код для инициализации WSGI-приложения.
    *   **Пример содержимого:**
        ```python
        import os
        from django.core.wsgi import get_wsgi_application
        # Убедитесь, что DJANGO_SETTINGS_MODULE указывает на production настройки для Docker
        os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'myproject.settings.prod')
        application = get_wsgi_application()
        ```
    *   **Важность:** Критично для запуска Gunicorn в Docker-контейнере.

2.  **Проверить и настроить `django/myproject/asgi.py` (при необходимости):**
    *   **Задача:** Если планируется использование ASGI (например, Django Channels для WebSockets), настроить файл. Если ASGI не используется, можно оставить минимальное содержимое или стандартное `get_asgi_application()`.
    *   **Пример (базовый):**
        ```python
        import os
        from django.core.asgi import get_asgi_application
        os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'myproject.settings.prod')
        application = get_asgi_application()
        ```
    *   **Важность:** Низкая, если ASGI не используется; высокая, если используется.

3.  **Конфигурация `DJANGO_SETTINGS_MODULE` в `myproject/celery.py`:**
    *   **Задача:** В `myproject/celery.py` сейчас `os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'myproject.settings.dev')`. В `Dockerfile` уже есть `ENV DJANGO_SETTINGS_MODULE=myproject.settings.prod`. Это не должно вызывать проблем в Docker, так как переменная окружения из Dockerfile будет иметь приоритет. Однако для консистентности и ясности можно рассмотреть удаление `os.environ.setdefault` из `celery.py`, если worker всегда запускается в окружении, где эта переменная уже установлена (например, через Docker ENV или systemd unit).
    *   **Важность:** Низкая (скорее улучшение для ясности).

## II. Доработка существующего функционала `core`

1.  **Кастомный валидатор паролей (`settings/base.py`):**
    *   **Задача:** В `AUTH_PASSWORD_VALIDATORS` ссылка на `myproject.apps.core.password_validators.LetterAndDigitValidator` раскомментирована в `AUTHENTICATION_BACKENDS`, но закомментирована в самом списке `AUTH_PASSWORD_VALIDATORS`. Определиться с его необходимостью:
        *   Если нужен: Реализовать (если еще нет) и раскомментировать в списке `AUTH_PASSWORD_VALIDATORS`.
        *   Если не нужен: Удалить упоминание из `AUTHENTICATION_BACKENDS` и закомментированную секцию из `AUTH_PASSWORD_VALIDATORS`.
    *   **Важность:** Средняя (для обеспечения консистентности настроек безопасности).

2.  **Финансовые поля в `UserProfileSerializer` (`core/serializers.py`):**
    *   **Задача:** Заменить заглушки для `total_deposit_amount`, `total_payout_amount`, `active_investment` реальной логикой подсчета.
    *   **Реализация:** Вероятно, потребуются методы в сериализаторе или модели `User` для агрегации данных из связанных моделей (например, `InvestmentAccount`, `WithdrawalRequest` из других приложений).
    *   **Важность:** Высокая (для полноты данных профиля пользователя).

3.  **GeoIP в `LoginHistory` (`core/models.py`):**
    *   **Задача:** Если планируется отображение GeoIP данных, реализовать их получение и сохранение.
    *   **Реализация:** Можно использовать сторонние библиотеки (например, `django-geoip2`) или API для определения местоположения по IP.
    *   **Важность:** Средняя (зависит от требований к отображению информации о входах).

4.  **Константы `DEVICE_TOKEN_COOKIE_NAME` и `DEVICE_TOKEN_COOKIE_MAX_AGE` (`core/views.py`):**
    *   **Задача:** Перенести эти закомментированные константы из `core/views.py` в файл настроек (например, `settings/base.py`).
    *   **Пример в `settings/base.py`:**
        ```python
        DEVICE_TOKEN_COOKIE_NAME = 'device_tkn'
        DEVICE_TOKEN_COOKIE_MAX_AGE_SECONDS = 90 * 24 * 60 * 60 # 90 дней
        ```
    *   **Важность:** Средняя (улучшение организации кода).

5.  **Email шаблоны:**
    *   **Задача:** Вместо простых текстовых сообщений в `send_mail` (например, при регистрации, верификации, сбросе 2FA) использовать HTML-шаблоны Django.
    *   **Реализация:** Создать HTML-шаблоны в директориях `templates` соответствующих приложений и использовать `render_to_string` для генерации тела письма.
    *   **Важность:** Средняя (улучшение пользовательского опыта).

## III. Реализация основного функционала (USDT Withdrawals - на основе первоначального контекста)

*   **Примечание:** Этот раздел основан на информации из предыдущего взаимодействия о разработке функционала вывода USDT.

1.  **Модель `WithdrawalRequest` (в `cross_arbitrage.models`):**
    *   **Задача:** Убедиться, что модель содержит все необходимые поля (`user`/`investment_account`, `amount`, `network`, `target_wallet`, `status`, `tx_hash`, `requested_at`, `processed_at`, `remarks` и т.д.) и корректно настроена.
    *   **Важность:** Высокая.

2.  **Сериализаторы для `WithdrawalRequest` (`cross_arbitrage.serializers`):**
    *   **`CreateWithdrawalRequestSerializer`:** Для создания запросов на вывод (валидация баланса, сети, адреса; уменьшение баланса; публикация в Redis).
    *   **`WithdrawalRequestSerializer`:** Для отображения истории выводов.
    *   **`WithdrawalRequestUpdateSerializer`:** Для Node.js воркера для обновления статуса, `tx_hash`, `remarks`.
    *   **Важность:** Высокая.

3.  **Views для `WithdrawalRequest` (`cross_arbitrage.views`):**
    *   Эндпоинт для создания запроса на вывод (использует `CreateWithdrawalRequestSerializer`).
    *   Эндпоинт для просмотра истории выводов (использует `WithdrawalRequestSerializer`).
    *   Эндпоинт для Node.js воркера для обновления статуса вывода (использует `WithdrawalRequestUpdateSerializer` и соответствующее разрешение).
    *   **Важность:** Высокая.

4.  **Celery Задача для обработки вывода:**
    *   **Задача:** Разработать Celery задачу, которая:
        *   Принимает ID `WithdrawalRequest`.
        *   Публикует сообщение в Redis для Node.js воркера с деталями транзакции.
        *   (Опционально) Управляет начальным статусом `WithdrawalRequest` (например, `processing`).
    *   **Важность:** Высокая.

5.  **Интеграция с Node.js (Redis Messaging):**
    *   **Задача:** Четко определить и задокументировать контракты сообщений Redis для взаимодействия между Django и Node.js (канал, тип сообщения, полезная нагрузка для запросов на вывод и обновлений статуса).
    *   Убедиться в корректной настройке URL Redis в `settings.py` (`REDIS_URL_FOR_PUBSUB`).
    *   **Важность:** Критическая для межсервисного взаимодействия.

## IV. Настройки Production и Docker

1.  **Файл настроек `settings/prod.py`:**
    *   **Задача:** Убедиться, что `prod.py` содержит все необходимые и безопасные настройки для производственной среды (`DEBUG = False`, корректные `ALLOWED_HOSTS`, `SECRET_KEY` из переменных окружения, настройки для статики/медиа, логирование, Email и т.д.).
    *   **Важность:** Критическая.

2.  **`.dockerignore` для статики/медиа:**
    *   **Задача:** Рассмотреть раскомментирование строк для исключения `staticfiles_collected/` и `mediafiles/`.
    *   **Условие:** Если статика всегда собирается в контейнере (`collectstatic` в `Dockerfile`) и медиа обрабатывается через volumes.
    *   **Важность:** Низкая (оптимизация размера образа).

## V. Тестирование и документация

1.  **Юнит-тесты и Интеграционные тесты:**
    *   **Задача:** Написать тесты для всех ключевых компонентов: модели, сериализаторы, views, особенно для процессов регистрации, аутентификации, 2FA, и новой логики вывода средств.
    *   **Важность:** Высокая (для обеспечения качества и надежности).

2.  **Документация API:**
    *   **Задача:** Если еще не сделано, рассмотреть использование инструментов типа `drf-yasg` или `drf-spectacular` для автоматической генерации OpenAPI/Swagger документации для вашего API.
    *   **Важность:** Средняя (для удобства разработки и интеграции с фронтендом или другими сервисами).

3.  **Документирование логики:**
    *   **Задача:** Добавить комментарии к неочевидным участкам кода, особенно в сложной бизнес-логике (например, процесс вывода, обновление балансов).
    *   **Важность:** Средняя (для поддержки и развития проекта).

## VI. Общие рекомендации

1.  **Логирование:**
    *   **Задача:** Проверить полноту логирования действий пользователя (`ActivityLog`) и системных событий (стандартное логирование Django в файлы или внешние системы в production).
    *   **Важность:** Высокая (для отладки, мониторинга и безопасности).

2.  **Безопасность:**
    *   **Задача:** Регулярно пересматривать настройки безопасности, обновлять зависимости, следить за уязвимостями.
    *   **Важность:** Постоянная. 