# Комплексный план доработок проекта (31-07-2024)

## I. Критические исправления и улучшения инфраструктуры Django

1.  **Исправить `django/myproject/wsgi.py`:**
    *   **Задача:** Добавить стандартный код для инициализации WSGI-приложения.
    *   **Пример:**
        ```python
        import os
        from django.core.wsgi import get_wsgi_application
        os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'myproject.settings.prod') # Убедитесь, что здесь prod
        application = get_wsgi_application()
        ```
    *   **Важность:** Критично (для Gunicorn в Docker).

2.  **Проверить/настроить `django/myproject/asgi.py`:**
    *   **Задача:** Настроить, если используется ASGI. Если нет, достаточно базовой конфигурации.
    *   **Важность:** Низкая/Высокая (в зависимости от использования ASGI).

3.  **Конфигурация `DJANGO_SETTINGS_MODULE` в `myproject/celery.py`:**
    *   **Задача:** Рассмотреть удаление `os.environ.setdefault` для ясности, т.к. Docker ENV должен иметь приоритет.
    *   **Важность:** Низкая.

## II. Доработка существующего функционала Django `core`

1.  **Кастомный валидатор паролей (`settings/base.py`):**
    *   **Задача:** Уточнить использование `LetterAndDigitValidator` и синхронизировать его объявление в `AUTHENTICATION_BACKENDS` и `AUTH_PASSWORD_VALIDATORS`.
    *   **Важность:** Средняя.

2.  **Финансовые поля в `UserProfileSerializer` (`core/serializers.py`):**
    *   **Задача:** Реализовать логику подсчета для `total_deposit_amount`, `total_payout_amount`, `active_investment`.
    *   **Важность:** Высокая.

3.  **GeoIP в `LoginHistory` (`core/models.py`):**
    *   **Задача:** Реализовать, если требуется отображение GeoIP данных.
    *   **Важность:** Средняя.

4.  **Константы Cookie в `core/views.py`:**
    *   **Задача:** Перенести `DEVICE_TOKEN_COOKIE_NAME`, `DEVICE_TOKEN_COOKIE_MAX_AGE_SECONDS` в `settings/base.py`.
    *   **Важность:** Средняя.

5.  **Email шаблоны:**
    *   **Задача:** Использовать HTML-шаблоны Django для email-уведомлений.
    *   **Важность:** Средняя.

## III. Развитие функционала Django `cross_arbitrage` (USDT Withdrawals и др.)

1.  **Модель `WithdrawalRequest`:**
    *   **Задача:** Финализировать структуру модели, убедиться в наличии всех полей и корректности их типов/ограничений.
    *   **Важность:** Высокая.

2.  **Сериализаторы `WithdrawalRequest`:**
    *   **Задача:** Доработать и тщательно протестировать `CreateWithdrawalRequestSerializer` (включая логику уменьшения баланса и отката), `WithdrawalRequestSerializer`, `WithdrawalRequestUpdateSerializer`.
    *   **Важность:** Высокая.

3.  **Views для `WithdrawalRequest`:**
    *   **Задача:** Завершить реализацию и тестирование API эндпоинтов для создания, просмотра и обновления запросов на вывод.
    *   **Важность:** Высокая.

4.  **Celery Задача для обработки вывода (`cross_arbitrage/tasks.py`):**
    *   **Задача:** Доработать Celery задачу, которая инициирует процесс вывода, публикуя сообщение в Redis для Node.js.
    *   **Важность:** Высокая.

5.  **Интеграция с Node.js (Redis Messaging):**
    *   **Задача:** Задокументировать и строго соблюдать контракты сообщений Redis (канал, тип, полезная нагрузка) для `withdrawals_cross_arbitrage` и `payouts_cross_arbitrage`.
    *   Проверить настройку `settings.REDIS_URL_FOR_PUBSUB`.
    *   **Важность:** Критическая.

## IV. Разработка и доработка Node.js (`node-wallet`)

1.  **Реализация блокчейн-сервисов (`services/`):**
    *   **Задача:** Завершить реализацию `tron.js` (включая `sendTRC20`, `prepareWalletForSweepTRC20`, `sweepTRC20`) и `evmService.js` (для Arbitrum, BEP20).
    *   Особое внимание уделить обработке комиссий, "fueling" кошельков для свипа, проверкам балансов (USDT и нативный токен для газа).
    *   **Важность:** Критическая.

2.  **Реализация `payout_engine.js` (`services/`):**
    *   **Задача:** Создать оркестратор, который будет вызывать нужные функции из `tron.js` или `evmService.js` на основе сети транзакции.
    *   **Важность:** Высокая.

3.  **Интеграция в `payout_worker.js` (`workers/`):**
    *   **Задача:** Заменить симуляции в `processDailyPayout` и `processWithdrawalRequest` реальными вызовами блокчейн-операций через `payout_engine.js`.
    *   **Важность:** Критическая.

4.  **Реализация `deposit_monitor.js` (`workers/`):**
    *   **Задача:** Полностью реализовать логику мониторинга депозитов в поддерживаемых сетях. Обеспечить надежную передачу данных о депозитах в Django API.
    *   **Важность:** Высокая.

5.  **Безопасность в Node.js:**
    *   **Задача:** Обеспечить безопасное хранение и использование приватных ключей и API-ключей для доступа к блокчейнам (через переменные окружения из `.env`). **Никаких ключей в коде!**
    *   **Важность:** Критическая.

6.  **Логирование и обработка ошибок в Node.js:**
    *   **Задача:** Внедрить комплексное логирование во все компоненты. Реализовать надежную обработку ошибок (сбои транзакций, недоступность API, проблемы с Redis) и, возможно, механизм повторных попыток для некоторых операций.
    *   **Важность:** Высокая.

7.  **Идемпотентность в Node.js воркерах:**
    *   **Задача:** Разработать механизм для предотвращения двойной обработки сообщений из Redis (особенно для выплат и выводов).
    *   **Важность:** Высокая.

8.  **Управление зависимостями Node.js:**
    *   **Задача:** Унифицировать HTTP-клиент (выбрать `axios` или `node-fetch`).
    *   Заполнить `package.json` всеми необходимыми полями (`name`, `version`, `main`, `scripts` для запуска воркеров, линтера, тестов, `devDependencies`).
    *   **Важность:** Средняя.

## V. Docker Compose, Nginx и Production окружение

1.  **Файл настроек `settings/prod.py` (Django):**
    *   **Задача:** Убедиться, что `prod.py` полностью сконфигурирован для production (`DEBUG = False`, `ALLOWED_HOSTS`, `SECRET_KEY` из env, логирование, Email и т.д.).
    *   **Важность:** Критическая.

2.  **Команда для `node-api` в `docker-compose.yml`:**
    *   **Задача:** Если сервис `node-api` используется, указать корректную команду для его запуска. Если не используется, рассмотреть удаление из `docker-compose.yml`.
    *   **Важность:** Средняя.

3.  **SSL для Nginx (`docker-compose.yml`, `nginx/default.conf`):**
    *   **Задача:** Спланировать и реализовать настройку SSL (HTTPS), используя, например, Let's Encrypt с Certbot.
    *   Раскомментировать и настроить соответствующие секции в `docker-compose.yml` и конфигурации Nginx.
    *   **Важность:** Высокая (для безопасности в production).

4.  **`.dockerignore` для статики/медиа (Django):**
    *   **Задача:** Рассмотреть раскомментирование строк для исключения `staticfiles_collected/` и `mediafiles/`, если статика собирается в контейнере, а медиа монтируется через volumes.
    *   **Важность:** Низкая.

## VI. Тестирование (Full Stack)

1.  **Юнит-тесты и Интеграционные тесты:**
    *   **Django:** Модели, сериализаторы, views, задачи Celery.
    *   **Node.js:** Модульные тесты для сервисов (`tron.js`, `evmService.js`, `payout_engine.js`), воркеров.
    *   **Интеграционные:** Тестирование потоков Django <-> Redis <-> Node.js <-> Django API.
    *   **Важность:** Высокая.

## VII. Документация (Full Stack)

1.  **Документация API Django:**
    *   **Задача:** Использовать `drf-yasg` или `drf-spectacular` для генерации OpenAPI/Swagger.
    *   Обновить `API_DOCUMENTATION.md` в `cross_arbitrage`.
    *   **Важность:** Средняя.

2.  **Документация Node.js:**
    *   **Задача:** Обновить `API.md` (если есть) и `README.md` в `node-wallet`.
    *   **Важность:** Средняя.

3.  **Документирование контрактов взаимодействия:**
    *   **Задача:** Создать или обновить документ, описывающий структуру сообщений Redis и эндпоинты API, используемые для связи Django и Node.js.
    *   **Важность:** Высокая.

4.  **Комментарии в коде:**
    *   **Задача:** Добавить комментарии к сложным или неочевидным участкам кода в обоих бэкендах.
    *   **Важность:** Средняя.

## VIII. Общие рекомендации

1.  **Комплексное логирование:**
    *   **Django:** `ActivityLog` для действий пользователя, стандартное логирование Django для системных событий (в файлы/внешние системы для production).
    *   **Node.js:** Детальное логирование операций, ошибок, взаимодействия с внешними сервисами.
    *   **Задача:** Рассмотреть централизованную систему логирования (например, ELK stack) для production.
    *   **Важность:** Высокая.

2.  **Безопасность:**
    *   **Задача:** Регулярный пересмотр настроек, обновление зависимостей, мониторинг уязвимостей, безопасное управление секретами во всех частях системы.
    *   **Важность:** Постоянная.

3.  **Мониторинг:**
    *   **Задача:** Настроить мониторинг ключевых метрик системы в production (производительность, использование ресурсов, очереди Redis, состояние Celery, ошибки).
    *   **Важность:** Высокая (для стабильной работы в production). 