# Документация API-эндпоинтов приложения `inter_exchange`

Приложение `inter_exchange` является частью модульной Django-системы, связанной с финансовыми и криптовалютными операциями. Оно отвечает за управление инвестиционными счетами между биржами, включая создание депозитов, обработку выплат и запросы на вывод средств. В этой документации описаны ключевые модели, API-эндпоинты, асинхронные задачи Celery, а также закомментированный код с предложениями по его использованию или рефакторингу.

## Обзор приложения

Приложение `inter_exchange` интегрировано с ядром системы (`core`) через модель `User` и, возможно, через модель `InvestmentStrategy` для определения параметров стратегии. Основной функционал включает:
- Создание и управление инвестиционными счетами между биржами.
- Генерацию временных кошельков для депозитов.
- Обработку выплат и запросов на вывод средств.
- Асинхронное начисление процентов через Celery-задачи.

## Ключевые модели данных

### 1. `InvestmentAccount`
- **Описание:** Представляет инвестиционный счет пользователя для межбиржевых операций.
- **Основные поля:**
  - `user` (ForeignKey к `core.User`): Связь с пользователем.
  - `network` (CharField с выбором из `NETWORK_CHOICES`): Сеть, используемая для операций (например, TRC20, BEP20).
  - `balance` (DecimalField): Текущий баланс счета.
  - `activated` (BooleanField): Статус активации счета.
  - `target_wallet` (CharField): Адрес целевого кошелька.
  - `lock_days` (IntegerField): Количество дней блокировки счета после активации.
  - `activation_date` (DateTimeField): Дата активации счета.
- **Свойства и методы:**
  - `is_locked`: Проверяет, заблокирован ли счет на основе `lock_days` и `activation_date`.
- **Meta:**
  - `unique_together`: Уникальность комбинации `user` и `network`, чтобы пользователь не мог иметь несколько счетов в одной сети.

### 2. `TemporaryWallet`
- **Описание:** Модель для временных кошельков, используемых для депозитов в межбиржевых операциях.
- **Основные поля:**
  - `user` (ForeignKey к `core.User`): Связь с пользователем.
  - `address` (CharField): Адрес временного кошелька.
  - `network` (CharField): Сеть кошелька.
  - `status` (CharField): Текущий статус кошелька (например, ожидание генерации, ожидание депозита).
  - `created_at` (DateTimeField): Дата создания кошелька.

### 3. `InvestmentDeposit`
- **Описание:** Модель для учета депозитов в инвестиционные счета.
- **Основные поля:**
  - `user` (ForeignKey к `core.User`): Связь с пользователем.
  - `amount` (DecimalField): Сумма депозита.
  - `created_at` (DateTimeField): Дата создания депозита.
  - `tx_hash` (CharField): Хэш транзакции.
  - `network` (CharField): Сеть, используемая для депозита.

### 4. `DailyPayout`
- **Описание:** Модель для учета ежедневных выплат по инвестиционным счетам.
- **Основные поля:**
  - `user` (ForeignKey к `core.User`): Связь с пользователем.
  - `amount` (DecimalField): Сумма выплаты.
  - `created_at` (DateTimeField): Дата выплаты.
  - `network` (CharField): Сеть, связанная с выплатой.

### 5. `InvestmentConfig`
- **Описание:** Конфигурация инвестиционной стратегии для межбиржевых операций.
- **Основные поля:**
  - `strategy_key` (CharField): Уникальный ключ стратегии.
  - `daily_rate` (DecimalField): Дневная ставка для начисления процентов.
  - `min_payout_amount` (DecimalField): Минимальная сумма для выплаты.
  - `lock_days` (IntegerField): Количество дней блокировки счета.

### 6. `WithdrawalRequest`
- **Описание:** Модель для запросов на вывод средств из инвестиционных счетов.
- **Основные поля:**
  - `user` (ForeignKey к `core.User`): Связь с пользователем.
  - `amount` (DecimalField): Сумма вывода.
  - `target_wallet` (CharField): Целевой кошелек для вывода.
  - `network` (CharField): Сеть для вывода.
  - `status` (CharField): Статус запроса (например, pending, processing, completed).
  - `created_at` (DateTimeField): Дата создания запроса.
  - `updated_at` (DateTimeField): Дата последнего обновления.

## API-эндпоинты

Все эндпоинты используют префикс `/api/inter_exchange/` и требуют авторизации через токен (Bearer Token), если не указано иное. Многие эндпоинты также используют разрешение `IsAuthenticated` и пользовательские разрешения, такие как `IsNodeWorker` из приложения `core` для операций, связанных с узлами.

### 1. Статус инвестиционных счетов
- **URL:** `/api/inter_exchange/investment-status/`
- **Метод:** GET
- **Разрешения:** `IsAuthenticated`
- **Описание:** Возвращает список инвестиционных счетов пользователя с информацией о балансе, статусе активации, целевом кошельке, сети, количестве дней блокировки, дате активации и статусе блокировки.
- **Ответ (200 OK):**
  ```json
  [
      {
          "id": 1,
          "network": "TRC20",
          "balance": "100.000000",
          "activated": true,
          "target_wallet": "wallet_address",
          "target_wallet_network": "TRC20",
          "lock_days": 30,
          "activation_date": "2025-07-01T00:00:00Z",
          "is_locked": false
      }
  ]
  ```

### 2. Создание депозита
- **URL:** `/api/inter_exchange/create-deposit/`
- **Метод:** POST
- **Разрешения:** `IsAuthenticated`
- **Описание:** Создает временный кошелек для депозита в указанной сети.
- **Запрос:**
  ```json
  {
      "network": "TRC20"
  }
  ```
- **Ответ (200 OK):**
  ```json
  {
      "message": "Временный кошелек создан",
      "wallet_address": "wallet_address",
      "network": "TRC20",
      "wallet_id": 123
  }
  ```
- **Ошибки:**
  - `400 Bad Request`: Если указана неподдерживаемая сеть.

### 3. Уведомление о депозите (для узлов)
- **URL:** `/api/inter_exchange/notify-deposit/`
- **Метод:** POST
- **Разрешения:** `IsNodeWorker`
- **Описание:** Уведомляет систему о депозите на временный кошелек. Вызывается узлом после обнаружения транзакции.
- **Запрос:**
  ```json
  {
      "wallet_id": 123,
      "amount": "50.000000",
      "tx_hash": "transaction_hash"
  }
  ```
- **Ответ (200 OK):**
  ```json
  {
      "message": "Депозит обработан"
  }
  ```

### 4. Статус свипа временного кошелька (для узлов)
- **URL:** `/api/inter_exchange/notify-sweep-status/`
- **Метод:** POST
- **Разрешения:** `IsNodeWorker`
- **Описание:** Обновляет статус свипа временного кошелька (успешно или с ошибкой).
- **Запрос:**
  ```json
  {
      "wallet_id": 123,
      "status": "success",
      "tx_hash": "sweep_transaction_hash"
  }
  ```
- **Ответ (200 OK):**
  ```json
  {
      "message": "Статус свипа обновлен"
  }
  ```

### 5. Активация инвестиционного счета
- **URL:** `/api/inter_exchange/activate-investment/`
- **Метод:** POST
- **Разрешения:** `IsAuthenticated`
- **Описание:** Активирует инвестиционный счет пользователя для указанной сети, если депозит подтвержден.
- **Запрос:**
  ```json
  {
      "network": "TRC20"
  }
  ```
- **Ответ (200 OK):**
  ```json
  {
      "message": "Инвестиционный счет активирован"
  }
  ```
- **Ошибки:**
  - `400 Bad Request`: Если счет уже активирован или сеть не поддерживается.
  - `403 Forbidden`: Если недостаточно прав.

### 6. Запрос на вывод средств
- **URL:** `/api/inter_exchange/withdraw-deposit/`
- **Метод:** POST
- **Разрешения:** `IsAuthenticated`
- **Описание:** Создает запрос на вывод средств из инвестиционного счета.
- **Запрос:**
  ```json
  {
      "network": "TRC20",
      "amount": "50.000000",
      "target_wallet": "wallet_address"
  }
  ```
- **Ответ (201 Created):**
  ```json
  {
      "message": "Запрос на вывод создан",
      "request_id": "uuid_string"
  }
  ```
- **Ошибки:**
  - `400 Bad Request`: Если недостаточно средств или сеть не поддерживается.

### 7. История депозитов
- **URL:** `/api/inter_exchange/deposit-history/`
- **Метод:** GET
- **Разрешения:** `IsAuthenticated`
- **Описание:** Возвращает историю депозитов пользователя.
- **Ответ (200 OK):**
  ```json
  [
      {
          "amount": "50.000000",
          "created_at": "2025-07-05T10:00:00Z",
          "tx_hash": "transaction_hash"
      }
  ]
  ```

### 8. История выплат
- **URL:** `/api/inter_exchange/payout-history/`
- **Метод:** GET
- **Разрешения:** `IsAuthenticated`
- **Описание:** Возвращает историю выплат по инвестиционным счетам пользователя.
- **Ответ (200 OK):**
  ```json
  [
      {
          "amount": "1.500000",
          "created_at": "2025-07-06T00:00:00Z",
          "network": "TRC20"
      }
  ]
  ```

### 9. История запросов на вывод
- **URL:** `/api/inter_exchange/withdrawal-history/`
- **Метод:** GET
- **Разрешения:** `IsAuthenticated`
- **Описание:** Возвращает историю запросов на вывод средств.
- **Ответ (200 OK):**
  ```json
  [
      {
          "amount": "50.000000",
          "target_wallet": "wallet_address",
          "network": "TRC20",
          "status": "pending",
          "created_at": "2025-07-10T10:00:00Z",
          "updated_at": "2025-07-10T10:00:00Z"
      }
  ]
  ```

### 10. Уведомление о выплате (для узлов)
- **URL:** `/api/inter_exchange/notify-payout/`
- **Метод:** POST
- **Разрешения:** `IsNodeWorker`
- **Описание:** Уведомляет систему о выплате, выполненной узлом. Использует Redis-каналы для обработки.
- **Запрос:**
  ```json
  {
      "user_id": 1,
      "amount": "1.500000",
      "network": "TRC20",
      "tx_hash": "payout_transaction_hash"
  }
  ```
- **Ответ (200 OK):**
  ```json
  {
      "message": "Выплата обработана"
  }
  ```

## Асинхронные задачи (Celery)

### 1. `process_daily_payouts`
- **Описание:** Периодическая задача для начисления процентов по инвестиционным счетам на основе дневной ставки. Проверяет активированные счета, у которых прошел период блокировки, и создает записи о выплатах.
- **Параметры:** Использует настройки из `django.conf.settings` для определения минимальной суммы выплаты и дневной ставки.

## Примеры `curl`-запросов для API-эндпоинтов

Ниже приведены примеры использования `curl` для взаимодействия с API-эндпоинтами приложения `inter_exchange`. Предполагается, что у вас есть токен авторизации (замените `your_auth_token` на действительный токен).

#### 1. Получение статуса инвестиционных счетов
```bash
curl -X GET \
  http://your-api-domain.com/api/inter_exchange/investment-status/ \
  -H "Authorization: Bearer your_auth_token" \
  -H "Content-Type: application/json"
```
**Ожидаемый ответ (200 OK):**
```json
[
    {
        "id": 1,
        "network": "TRC20",
        "balance": "100.000000",
        "activated": true,
        "target_wallet": "wallet_address",
        "target_wallet_network": "TRC20",
        "lock_days": 30,
        "activation_date": "2025-07-01T00:00:00Z",
        "is_locked": false
    }
]
```

#### 2. Создание депозита
```bash
curl -X POST \
  http://your-api-domain.com/api/inter_exchange/create-deposit/ \
  -H "Authorization: Bearer your_auth_token" \
  -H "Content-Type: application/json" \
  -d '{"network": "TRC20"}'
```
**Ожидаемый ответ (200 OK):**
```json
{
    "message": "Временный кошелек создан",
    "wallet_address": "wallet_address",
    "network": "TRC20",
    "wallet_id": 123
}
```

#### 3. Активация инвестиционного счета
```bash
curl -X POST \
  http://your-api-domain.com/api/inter_exchange/activate-investment/ \
  -H "Authorization: Bearer your_auth_token" \
  -H "Content-Type: application/json" \
  -d '{"network": "TRC20"}'
```
**Ожидаемый ответ (200 OK):**
```json
{
    "message": "Инвестиционный счет активирован"
}
```

#### 4. Запрос на вывод средств
```bash
curl -X POST \
  http://your-api-domain.com/api/inter_exchange/withdraw-deposit/ \
  -H "Authorization: Bearer your_auth_token" \
  -H "Content-Type: application/json" \
  -d '{"network": "TRC20", "amount": "50.000000", "target_wallet": "wallet_address"}'
```
**Ожидаемый ответ (201 Created):**
```json
{
    "message": "Запрос на вывод создан",
    "request_id": "uuid_string"
}
```

#### 5. Получение истории депозитов
```bash
curl -X GET \
  http://your-api-domain.com/api/inter_exchange/deposit-history/ \
  -H "Authorization: Bearer your_auth_token" \
  -H "Content-Type: application/json"
```
**Ожидаемый ответ (200 OK):**
```json
[
    {
        "amount": "50.000000",
        "created_at": "2025-07-05T10:00:00Z",
        "tx_hash": "transaction_hash"
    }
]
```

Примечание: Замените `http://your-api-domain.com` на фактический домен вашего API. Убедитесь, что вы используете правильный токен авторизации для каждого запроса.

## Закомментированный код

### В файле `models.py`
- **Место:** Возможны закомментированные статусы для модели `TemporaryWallet` (например, `TEMP_WALLET_STATUS_PENDING_GENERATION`, `TEMP_WALLET_STATUS_PENDING_DEPOSIT`).
- **Назначение:** Эти константы могли быть частью более сложной системы управления временными кошельками, которая на данный момент либо упрощена, либо временно отключена.
- **Предложение по использованию:**
  1. **Раскомментировать и внедрить:** Если потребуется детальное управление временными кошельками, эти статусы можно использовать в логике приложения.
  2. **Удалить для упрощения:** Если текущая система статусов достаточна, закомментированный код можно удалить для повышения читаемости файла.
  3. **Рефакторинг:** В качестве альтернативы, можно использовать перечисления (`enum` из Python), что улучшит организацию кода и упростит его поддержку.

## Возможность выбора сети пользователем

В приложении `inter_exchange` пользователи имеют возможность выбирать сеть для своих операций (депозитов, выводов и временных кошельков). Это реализовано через поле `network` в моделях и API-эндпоинтах. Доступные сети определены в `NETWORK_CHOICES` в модели `InvestmentAccount` и других соответствующих моделях. На момент анализа кода доступны следующие сети:
- **TRC20** (Tron)
- **BEP20** (BNB Smart Chain)
- **ARBITRUM** (Arbitrum)

### Как пользователь выбирает сеть:
1. **При создании депозита или временного кошелька**: Пользователь указывает желаемую сеть в поле `network` в запросе к эндпоинтам, таким как `/api/inter_exchange/create-deposit/`.
2. **При активации счета**: Пользователь указывает сеть, к которой привязан счет, чтобы активировать его.
3. **При выводе средств**: Пользователь выбирает сеть для вывода средств через поле `network` в запросе к `/api/inter_exchange/withdraw-deposit/`.

### Ограничения и валидация:
- Выбор сети валидируется на уровне API-сериализаторов и моделей. Если указана неподдерживаемая сеть, запрос отклоняется с ошибкой `400 Bad Request`.
- Уникальность счета пользователя для каждой сети обеспечивается через `unique_together` в мета-классе модели `InvestmentAccount`.

### Возможные улучшения:
- Добавить эндпоинт для получения списка доступных сетей динамически.
- Включить информацию о комиссиях или минимальных суммах для каждой сети, если это применимо.

## Итог

Приложение `inter_exchange` предоставляет полный набор API-эндпоинтов для управления инвестиционными счетами между биржами, включая создание депозитов, активацию счетов, запросы на вывод средств и мониторинг временных кошельков. Оно тесно интегрировано с ядром системы (`core`) через модель `User` и, возможно, через модель `InvestmentStrategy`. Асинхронные задачи Celery обеспечивают автоматическое начисление процентов. Закомментированный код указывает на потенциально более сложную систему управления временными кошельками, и его дальнейшее использование или удаление зависит от планов по развитию функциональности.

Если у вас есть дополнительные вопросы или требуется дальнейшая детализация, дайте знать!
